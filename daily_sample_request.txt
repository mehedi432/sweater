SELECT
    dsr.requested_time AS "Requested On:Datetime:140",
    CASE
        WHEN dsr.reference_image IS NOT NULL AND dsr.reference_image != ''
        THEN CONCAT('<img src="', dsr.reference_image, '" width="80" />')
        ELSE ''
    END AS "Reference Image:HTML:150",
    dsr.name AS "Sample ID:Link/Daily Sample Request:120",
    dsr.buyer AS "Buyer:Link/Customer:120",
    dsr.style AS "Style Code:Data:100",
    dsr.color AS "Color:Data:100",
    dsr.order_qty AS "Order Quanity:Data:100",
    dsr.sample_type AS "Sample Type:Data:120",
    dsr.urgency_priority AS "Priority:Data:80",
    dsr.merchandiser_display AS "Merchandiser:Data:100",
    dsr.designer AS "Designer:Link/Employee:100",
    dsr.gauge AS "Gauge:Data:80",
    dsr.over_all_status AS "Overall Status:Data:150",
    dsr.workflow_state AS "Workflow Status:Data:120",

    GROUP_CONCAT(DISTINCT mr.yarn_composition) AS "Yarn Composition:Data:150",
    GROUP_CONCAT(DISTINCT mr.yarn_count) AS "Yarn Count:Data:150",

    DATEDIFF(NOW(), dsr.requested_time) AS "Days Since Request:Int:60",
    dsr.knitting_time AS "Knitting Time (hrs):Float:80",
    dsr.approximate_delivery_date AS "Expected Delivery:Date:120",
    dsr.remarks AS "Remarks:Data:100"

FROM
    `tabDaily Sample Request` dsr
LEFT JOIN
    `tabMaterial Requirement` mr
ON
    mr.parent = dsr.name
WHERE
    dsr.docstatus < 2
    AND (%(buyer)s IS NULL OR %(buyer)s = '' OR dsr.buyer = %(buyer)s)
    AND (%(start_date)s IS NULL OR %(start_date)s = '' OR DATE(dsr.requested_time) >= %(start_date)s)
    AND (%(end_date)s IS NULL OR %(end_date)s = '' OR DATE(dsr.requested_time) <= %(end_date)s)
GROUP BY
    dsr.name
ORDER BY
    dsr.requested_time DESC;

